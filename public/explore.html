<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <link rel="stylesheet" href="styles.css">
        <style>
            body { margin:0; font-family: sans-serif; display: flex;}
            .mapcontainer { height:100vh; width: 70%; position: relative;}
            #places-list {width: 30%; overflow-y: auto; background: #f9f9f9; padding: 10px;}
            ul { list-style-type: none; padding: 0;}
            li { margin: 8px 0; background: #eee; padding: 8px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;}
            .place-info { color: black; flex: 1;}
            .remove-btn { background-color: red; color:white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; margin-left: 10px;}
            .clear-all-btn { background-color: #ff6b6b; color: white; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer; margin-bottom: 10px; width: 100%;}
            
            /* Search Box Styles */
            .search-container {
                position: absolute;
                top: 10px;
                left: 50px;
                z-index: 1000;
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                width: 300px;
            }
            
            .search-input {
                width: 100%;
                padding: 12px 15px;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                outline: none;
                box-sizing: border-box;
            }
            
            .search-results {
                max-height: 200px;
                overflow-y: auto;
                border-top: 1px solid #eee;
                display: none;
            }
            
            .search-result-item {
                padding: 10px 15px;
                cursor: pointer;
                border-bottom: 1px solid #f0f0f0;
                font-size: 13px;
            }
            
            .search-result-item:hover {
                background-color: #f5f5f5;
            }
            
            .search-result-item:last-child {
                border-bottom: none;
            }
            
            .loading {
                padding: 10px 15px;
                color: #666;
                font-style: italic;
            }
        </style>
    </head>
    <body>
        <div id="map" class="mapcontainer">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search for places..." id="searchInput">
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>
        <div id="places-list">
            <h3>Places</h3>
            <button class="clear-all-btn" onclick="clearAllPlaces()">Clear All Places</button>
            <ul id="placeItems"></ul>
        </div>
        <script>
            const map = L.map('map').setView([28.6139, 77.2090], 5);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            let places = [];
            let searchTimeout;
            let currentSearchMarker = null;

            // Initialize with some sample data that will persist
            function initializePlaces() {
                // This simulates persistent data - in a real app you'd use localStorage
                if (!window.persistentPlaces) {
                    window.persistentPlaces = [
                        { name: "Delhi", status: "Visited", lat: 28.6139, lng: 77.2090 },
                        { name: "Mumbai", status: "Future", lat: 19.0760, lng: 72.8777 },
                        { name: "Udaipur", status: "Visited", lat: 24.5854, lng: 73.7125 }
                    ];
                }
                loadPlaces();
            }

            // Search functionality
            async function searchPlaces(query) {
                if (query.length < 3) {
                    hideSearchResults();
                    return;
                }

                showLoading();

                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`);
                    const results = await response.json();
                    displaySearchResults(results);
                } catch (error) {
                    console.error('Search error:', error);
                    hideSearchResults();
                }
            }

            function showLoading() {
                const resultsDiv = document.getElementById('searchResults');
                resultsDiv.innerHTML = '<div class="loading">Searching...</div>';
                resultsDiv.style.display = 'block';
            }

            function hideSearchResults() {
                const resultsDiv = document.getElementById('searchResults');
                resultsDiv.style.display = 'none';
            }

            function displaySearchResults(results) {
                const resultsDiv = document.getElementById('searchResults');
                
                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div class="loading">No results found</div>';
                    return;
                }

                resultsDiv.innerHTML = '';
                
                results.forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `<strong>${result.display_name}</strong>`;
                    
                    item.onclick = () => {
                        selectSearchResult(result);
                    };
                    
                    resultsDiv.appendChild(item);
                });
                
                resultsDiv.style.display = 'block';
            }

            function selectSearchResult(result) {
                const lat = parseFloat(result.lat);
                const lng = parseFloat(result.lon);
                
                // Remove previous search marker if exists
                if (currentSearchMarker) {
                    map.removeLayer(currentSearchMarker);
                }
                
                // Add temporary search marker
                currentSearchMarker = L.marker([lat, lng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map);
                
                // Add popup with option to save
                currentSearchMarker.bindPopup(`
                    <div>
                        <strong>${result.display_name}</strong><br>
                        <button onclick="saveSearchedPlace('${result.display_name.replace(/'/g, "\\'")}', ${lat}, ${lng})" 
                                style="margin-top: 8px; padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            Save this place
                        </button>
                    </div>
                `).openPopup();
                
                // Zoom to location
                map.setView([lat, lng], 13);
                
                // Hide search results
                hideSearchResults();
                document.getElementById('searchInput').value = '';
            }

            function saveSearchedPlace(name, lat, lng) {
                const status = prompt("Enter status (e.g., 'Visited', 'Future', 'Planning'):", "Future");
                if (!status) return;

                // Remove search marker
                if (currentSearchMarker) {
                    map.removeLayer(currentSearchMarker);
                    currentSearchMarker = null;
                }

                // Add permanent marker
                const marker = L.marker([lat, lng]).addTo(map)
                    .bindPopup(`<strong>${name}</strong><br>Status: ${status}<br>Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`);

                places.push({ name, status, lat, lng, marker });
                updatePlacesList();
                savePlaces();
            }

            // Load places from persistent storage
            function loadPlaces() {
                places = [...window.persistentPlaces];
                places.forEach(place => {
                    const marker = L.marker([place.lat, place.lng]).addTo(map)
                        .bindPopup(`<strong>${place.name}</strong><br>Status: ${place.status}<br>Lat: ${place.lat.toFixed(4)}, Lng: ${place.lng.toFixed(4)}`);
                    place.marker = marker;
                });
                updatePlacesList();
            }

            // Save places to persistent storage
            function savePlaces() {
                window.persistentPlaces = places.map(place => ({
                    name: place.name,
                    status: place.status,
                    lat: place.lat,
                    lng: place.lng
                }));
            }

            function updatePlacesList() {
                const list = document.getElementById('placeItems');
                list.innerHTML = '';
                places.forEach((place, index) => {
                    const li = document.createElement('li');
                    const info = document.createElement('div');
                    info.className = 'place-info';
                    info.innerHTML = `<strong>${place.name}</strong><br>
                                      Status: ${place.status}<br>
                                      Lat: ${place.lat.toFixed(4)}, Lng: ${place.lng.toFixed(4)}`;

                    const btn = document.createElement('button');
                    btn.innerText = 'Remove';
                    btn.className = 'remove-btn';
                    btn.onclick = () => {
                        map.removeLayer(place.marker);
                        places.splice(index, 1);
                        updatePlacesList();
                        savePlaces();
                    };

                    li.appendChild(info);
                    li.appendChild(btn);
                    list.appendChild(li);
                });
            }

            function clearAllPlaces() {
                if (confirm('Are you sure you want to remove all places?')) {
                    places.forEach(place => {
                        map.removeLayer(place.marker);
                    });
                    places = [];
                    window.persistentPlaces = [];
                    updatePlacesList();
                }
            }

            map.on('click', function(e) {
                // Hide search results if clicking on map
                hideSearchResults();
                
                const { lat, lng } = e.latlng;
                const name = prompt("Enter place name:");
                if (!name) return;

                const status = prompt("Enter status (e.g., 'Visited', 'Future', 'Planning'):");
                if (!status) return;

                const marker = L.marker([lat, lng]).addTo(map)
                    .bindPopup(`<strong>${name}</strong><br>Status: ${status}<br>Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`);

                places.push({ name, status, lat, lng, marker });
                updatePlacesList();
                savePlaces();
            });

            // Search input event listeners
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const query = e.target.value.trim();
                
                // Clear previous timeout
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                // Set new timeout for search (debounce)
                searchTimeout = setTimeout(() => {
                    searchPlaces(query);
                }, 300);
            });

            // Hide search results when clicking outside
            document.addEventListener('click', function(e) {
                const searchContainer = document.querySelector('.search-container');
                if (!searchContainer.contains(e.target)) {
                    hideSearchResults();
                }
            });

            // Expose saveSearchedPlace to global scope for onclick
            window.saveSearchedPlace = saveSearchedPlace;

            // Load places when page loads
            initializePlaces();
        </script>
     </body> 
</html>